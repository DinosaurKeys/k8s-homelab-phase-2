# =============================================================================
# CONFIGMAP FOR NGINX INGRESS CONTROLLER
# =============================================================================
# This ConfigMap controls NGINX behavior
# The controller reads these and generates nginx.conf
#
# Common settings you might want to change:
# - proxy-body-size: Max upload size (default 1m)
# - proxy-read-timeout: Backend timeout (default 60s)
# - use-forwarded-headers: Trust X-Forwarded-* headers
# - ssl-protocols: TLS versions to support
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/component: controller
data:
  # Allow larger file uploads (default is 1m which is too small)
  proxy-body-size: "50m"
  
  # Trust forwarded headers from HAProxy/Load Balancer
  use-forwarded-headers: "true"
  compute-full-forwarded-for: "true"
  
  # Proxy timeouts (increase for slow backends)
  proxy-connect-timeout: "10"
  proxy-read-timeout: "120"
  proxy-send-timeout: "120"
  
  # Keep-alive connections to backends
  upstream-keepalive-connections: "100"
  
  # Logging format (useful for debugging)
  log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id'
  
  # Enable real IP detection (when behind proxy)
  enable-real-ip: "true"
  
  # SSL settings (modern only - TLS 1.2+)
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-prefer-server-ciphers: "true"
  
  # HSTS (HTTP Strict Transport Security)
  hsts: "true"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "true"
  
  # Enable metrics endpoint for Prometheus
  enable-prometheus-metrics: "true"
